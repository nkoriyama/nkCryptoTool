## nkCryptoTool 暗号化・復号ベンチマーク結果のまとめ

このドキュメントは、`nkCryptoTool` の暗号化および復号機能のパフォーマンスベンチマーク結果をまとめたものです。ECC、PQC、Hybridの3つの暗号化モードと、1KB、1MB、10MB、そして6.7GBのファイルサイズで測定を行いました。

### 測定環境

*   **CPU**: 16 X 5271.62 MHz CPU
*   **CPUキャッシュ**: L1 Data 48 KiB (x8), L1 Instruction 32 KiB (x8), L2 Unified 1024 KiB (x8), L3 Unified 98304 KiB (x1)

### 結果概要

各ベンチマークは、指定されたファイルサイズとモードで実行された際の平均実時間 (Time) と平均CPU時間 (CPU) を示します。

#### 暗号化 (Encryption) パフォーマンス

| ファイルサイズ | モード  | Time (ms) | CPU (ms) | Iterations |
| :------------- | :------ | :-------- | :------- | :--------- |
| 1KB            | ECC     | 0.342     | 0.302    | 2624       |
| 1KB            | PQC     | 0.429     | 0.343    | 2305       |
| 1KB            | Hybrid  | 0.647     | 0.526    | 1000       |
| 1MB            | ECC     | 3.804     | 3.720    | 195        |
| 1MB            | PQC     | 3.820     | 3.684    | 196        |
| 1MB            | Hybrid  | 4.089     | 3.948    | 182        |
| 10MB           | ECC     | 34.917    | 34.061   | 20         |
| 10MB           | PQC     | 35.216    | 34.828   | 19         |
| 10MB           | Hybrid  | 34.567    | 33.714   | 20         |
| 6.7GB          | ECC     | 21020     | 20912    | 1          |
| 6.7GB          | PQC     | 20286     | 20074    | 1          |
| 6.7GB          | Hybrid  | 23896     | 23758    | 1          |

#### 復号 (Decryption) パフォーマンス

| ファイルサイズ | モード  | Time (ms) | CPU (ms) | Iterations |
| :------------- | :------ | :-------- | :------- | :--------- |
| 1KB            | ECC     | 0.660     | 0.502    | 1493       |
| 1KB            | PQC     | 0.773     | 0.582    | 1220       |
| 1KB            | Hybrid  | 0.946     | 0.740    | 925        |
| 1MB            | ECC     | 4.122     | 3.999    | 178        |
| 1MB            | PQC     | 4.202     | 4.066    | 177        |
| 1MB            | Hybrid  | 4.463     | 4.353    | 163        |
| 10MB           | ECC     | 33.585    | 33.390   | 20         |
| 10MB           | PQC     | 34.251    | 34.020   | 20         |
| 10MB           | Hybrid  | 34.666    | 34.004   | 22         |
| 6.7GB          | ECC     | 17711     | 17662    | 1          |
| 6.7GB          | PQC     | 19931     | 19799    | 1          |
| 6.7GB          | Hybrid  | 19689     | 19505    | 1          |

### スループット (Bytes per second - Bps)

スループットは、ファイルサイズを処理時間で割ることで計算されます。値が大きいほど、より多くのデータを単位時間あたりに処理できることを意味します。

#### 暗号化 (Encryption) スループット

| ファイルサイズ | モード  | スループット (Bps) |
| :------------- | :------ | :------------------- |
| 1KB            | ECC     | 3,019,255            |
| 1KB            | PQC     | 2,447,208            |
| 1KB            | Hybrid  | 1,600,000            |
| 1MB            | ECC     | 275,677,410          |
| 1MB            | PQC     | 273,847,949          |
| 1MB            | Hybrid  | 256,419,000          |
| 10MB           | ECC     | 300,317,678          |
| 10MB           | PQC     | 297,713,678          |
| 10MB           | Hybrid  | 303,485,300          |
| 6.7GB          | ECC     | 319,642,000          |
| 6.7GB          | PQC     | 331,100,000          |
| 6.7GB          | Hybrid  | 280,000,000          |

#### 復号 (Decryption) スループット

| ファイルサイズ | モード  | スループット (Bps) |
| :------------- | :------ | :------------------- |
| 1KB            | ECC     | 1,559,219            |
| 1KB            | PQC     | 1,355,756            |
| 1KB            | Hybrid  | 1,085,405            |
| 1MB            | ECC     | 254,395,000          |
| 1MB            | PQC     | 249,500,000          |
| 1MB            | Hybrid  | 234,484,000          |
| 10MB           | ECC     | 312,234,000          |
| 10MB           | PQC     | 306,140,000          |
| 10MB           | Hybrid  | 302,572,000          |
| 6.7GB          | ECC     | 379,360,000          |
| 6.7GB          | PQC     | 337,100,000          |
| 6.7GB          | Hybrid  | 341,200,000          |

### 主要な考察

今回のベンチマーク結果と、`PipelineManager.hpp`に導入されたバックプレッシャー機構の変更点を踏まえると、以下のような考察ができます。

1.  **バックプレッシャー機構の導入とその影響:**
    `PipelineManager.hpp`に導入されたバックプレッシャー機構は、ファイル読み込みプロセスがデータ処理ステージを過剰に先行するのを防ぐ目的があります。これにより、タスクキューが一杯になった際に読み込みを一時停止し、メモリ使用量を抑制します。

    *   **安定性とメモリ管理の改善:** 大容量ファイルを処理する際のパイプラインの安定性が向上し、メモリ枯渇やそれに伴う性能低下のリスクが低減されます。これは、堅牢なシステム運用において極めて好ましい影響です。
    *   **大容量ファイル (6.7GB) のECC処理での顕著な改善:** ECCモードの復号では約18.5%の高速化、暗号化でもわずかながら改善が見られました。これは、以前の実装がメモリ律速となっていた部分で、バックプレッシャーがボトルネックを解消したことを強く示唆しています。
    *   **小〜中サイズファイルでの微量なオーバーヘッド:** 1KB、1MB、10MBといった小〜中サイズのファイルでは、ほとんどの暗号化処理で1〜8%程度のわずかな性能低下が見られます。これは、バックプレッシャーのチェック機構によるわずかなオーバヘッドであり、これらのケースではバックプレッシャーの恩恵が小さいため、コストが目立つ結果となっています。
    *   **PQCおよびHybridモード（6.7GB）での性能低下:** 一方で、CPU集約的なPQCおよびHybridモードでは、6.7GBファイルにおいて性能低下が見られました。これは、バックプレッシャーによってデータ供給が一時的に途切れることが、常にCPUをフル活用したいこれらのモードの処理効率を妨げた可能性があります。

2.  **モード間のパフォーマンス差異とスループットの変動:**
    *   **ECCモード:** 大容量ファイルでの復号スループットが大幅に向上しており、バックプレッシャー機構による恩恵を最も大きく受けています。
    *   **PQCモード:** 1KBファイルの復号スループットは改善しましたが、6.7GBファイルでのスループットは低下しました。CPUバウンドな特性とバックプレッシャーの相互作用が影響していると考えられます。
    *   **Hybridモード:** 1KBファイルの復号スループットは低下しましたが、暗号化では他のモードと同様の傾向を示しました。6.7GBファイルでのスループットも低下しており、PQCと同様にバックプレッシャーの影響を受けている可能性があります。

### まとめ

`PipelineManager.hpp`へのバックプレッシャー機構の導入は、特に大容量ファイル処理におけるシステムの**安定性向上とメモリ効率の改善**という点で**非常に好ましい**変更です。これにより、メモリ律速となりがちな処理（特にECCの復号）で顕著な性能向上が見られました。

一方で、小〜中サイズのファイルや、CPU集約的なPQC/Hybridモードでは、機構のオーバーヘッドやデータ供給の一時的な中断により、わずかな性能低下が発生するトレードオフの関係にあります。この結果から、PipelineManagerはより堅牢なデータ処理パイプラインへと進化しましたが、CPUバウンドな処理のさらなる最適化については、今後も検討の余地があると言えるでしょう。
